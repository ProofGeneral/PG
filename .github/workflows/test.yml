name: CI

on:
  push:
    branches:
      #- master
      #- hybrid
      - "**"
  pull_request:
    branches:
      - '**'

jobs:
  container-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        emacs_version:
          - '27.2'
        coq_version:
          - '8.14'
      fail-fast: false
    container: proofgeneral/coq-emacs:coq-${{matrix.coq_version}}-emacs-${{matrix.emacs_version}}
    # github set HOME to /home/runner, need to overwrite this
    env:
      HOME: /home/coq

    # GITHUB_WORKSPACE (/__w/PG/PG), the directory where the
    # checkout happens, appears in the container as user runner
    # (uid 1001) with group docker (121). These uid and gid don't
    # exist in the containter. Actions in the container run with
    # user coq (uid 1000). Therefore need to change ownership.
    steps:
    - run: sudo chown $USER.$USER $GITHUB_WORKSPACE
    - uses: actions/checkout@v2

    - name: setup nix and OCaml environment and PATH
      # Each step runs with a fresh environment. To preserve the
      # environment, var=value strings must be put into
      # $GITHUB_ENV. This file however is created with githubs user
      # id and cannot be written from user coq in the container.
      # opam env adds export statements, therefore opam env >>
      # $GITHUB_ENV does not work.
      run: |
        . /home/coq/.nix-profile/etc/profile.d/nix.sh
        eval $(opam env)
        sudo chown $USER.$USER $GITHUB_ENV
        echo "OPAM_SWITCH_PREFIX=$OPAM_SWITCH_PREFIX" >> $GITHUB_ENV
        echo "CAML_LD_LIBRARY_PATH=$CAML_LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "OCAML_TOPLEVEL_PATH=$OCAML_TOPLEVEL_PATH" >> $GITHUB_ENV
        echo "PATH=$PATH" >> $GITHUB_ENV

    - name: print versions and configuration
      run: |
        echo getconf _NPROCESSORS_ONLN: $(getconf _NPROCESSORS_ONLN)
        emacs --version
        coqc --version
        ocaml --version

    # finally run the tests
    - run: make -C ci/compile-tests test
