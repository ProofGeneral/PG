# See ../../ci/doc/README.{md,pdf} for documentation about continuous
# integration and testing of Proof General.
#
# The versions to be tested in between the CIPG markers are now and
# then automatically updated. Please consider this when changing this
# file.
#
name: CI

on:
  push:
    branches:
      #- master
      #- hybrid
      - "**"
  pull_request:
    branches:
      - '**'

jobs:
  ###########################################################################
  ####### Additional tests in ci/simple-tests for Coq
  ###########################################################################
  simple-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        coq_emacs_version:
          # The content between the CIPG markers is automatically
          # changed by the cipg program. Do not change these markers.
          # CIPG change marker: simple-coq-emacs-versions
          - coq-8.11.2-emacs-29.2
          - coq-8.12.2-emacs-29.2
          - coq-8.13.2-emacs-29.2
          - coq-8.14.1-emacs-29.2
          - coq-8.15.2-emacs-29.2
          - coq-8.16.1-emacs-29.2
          - coq-8.17.1-emacs-29.2
          - coq-8.18.0-emacs-29.2
          - coq-8.19.1-emacs-29.2
          # CIPG change marker end
      # don't cancel all in-progress jobs if one matrix job fails:
      fail-fast: false

    steps:
    - uses: actions/checkout@v2

    - name: Add ert problem matcher
      run: echo "::add-matcher::.github/ert.json"
      
    - uses: coq-community/docker-coq-action@v1
      id: docker-coq-action
      with:
        opam_file: 'dummy.opam'
        custom_image: proofgeneral/coq-emacs:${{matrix.coq_emacs_version}}
        custom_script: |
          startGroup Run tests
            git --version
            sudo chown -R coq:coq ./ci
            pwd
            id
            ls -la
            ls -la .git
            git diff --exit-code
          endGroup
